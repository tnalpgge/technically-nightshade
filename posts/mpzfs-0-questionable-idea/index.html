<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content><link href="https://fonts.googleapis.com/css?family=Newsreader:400|Fira+Code:400|Inter:400|EB+Garamond:400&display=swap" rel=stylesheet media=print type=text/css onload='this.media="all"'><title>Multiple Personality ZFS Part 0: A Questionable Idea
</title><link rel=canonical href=https://tnalpgge.github.io/technically-nightshade/posts/mpzfs-0-questionable-idea/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:Newsreader,free serif,times new roman,Times,serif;font-size:x-large;line-height:108%;color:#000;max-width:72%;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre{font:"Fira Code",Courier,courier new,Menlo,Monaco,andale mono,lucida console,monospace;background-color:#eee}code{font-size:medium;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:medium;line-height:126%}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:Inter,Helvetica,liberation sans,sans-serif}.mono,pre,code,tt,p code,li code{font-family:fira code,Courier,courier new,Menlo,Monaco,andale mono,lucida console,monospace}.heading,h1,.serif{font-family:Newsreader,free serif,times new roman,Times,serif}h2,h3,h4,h5,h6,.sans-serif{font-family:Inter,Helvetica,liberation sans,sans-serif;font-weight:700}strong{font-weight:600}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:eb garamond,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:eb garamond,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-size:35px}h2{font-size:28px}h3{font-size:22px;margin-top:18px}h1 a,h3 a{text-decoration:none}h2 a{font-family:Newsreader,free serif,times new roman,Times,serif}h1,h2{margin-top:28px}#sub-header,.date{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content .date{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:ttable-cell;font-size:15px;padding:0 20px;font-family:Inter,Helvetica,liberation sans,sans-serif}#links{display:flex;justify-content:space-between;margin:50px 0 0}#links :nth-child(1){margin-right:.5em}#links :nth-child(2){margin-left:.5em}#not-found{text-align:center}#not-found a{font-family:eb garamond,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}dt{font-weight:700;font-style:italic}dd{padding-left:3%}a{color:#080}a:visited{color:#808}a:hover{color:#fff;background-color:#080}.footnote-ref{vertical-align:super;font-size:smaller}table{width:90%}th{font-family:Inter,Helvetica,liberation sans,sans-serif;font-weight:700;border-bottom:1px solid #888}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}@media(prefers-color-scheme:dark){*,#nav h1 a{color:#fdfdfd}body{background:#121212}pre,code{background-color:#262626}#sub-header,.date{color:#bababa}hr{background:#ebebeb}}</style></head><body><section id=nav><h1><a href=/>tnalpgge.github.io</a></h1><ul><li><a href=/technically-nightshade/>Technically Nightshade</a></li></ul></section><section id=content><h1>Multiple Personality ZFS Part 0: A Questionable Idea</h1><div id=sub-header>27 December 2022 · 8 minute read</div><div class=entry-content><h2 id=introduction>Introduction</h2><p>I have a computer that I use for a hobby of mine. And it runs a decent operating system for what I want to accomplish with it. But it&rsquo;s not my preferred operating system. I wonder if I can share my home directory between two operating systems that never run concurrently. That sounds a lot better than copying files back and forth in an effort to keep things in sync.</p><p>The hobby is kind of niche. And the people who use <a href=https://unix.org/>UNIX</a>-like operating systems for that hobby is sub-niche. And people who use <a href=https://en.wikipedia.org/wiki/Berkeley_Software_Distribution>BSD</a>-based operating systems for that hobby is sub-sub-niche. So I&rsquo;m not expecting any sort of revolution to spawn out of this. In fact, this is arguably a useless exercise. But why let that stop us from exploring? Maybe we&rsquo;ll learn something useful along the way.</p><p>I have spread story of this journey across a series of posts:</p><ul><li><strong><a href=../mpzfs-0-questionable-idea>Part 0: A Questionable Idea</a></strong> ⇐ you are here</li><li><a href=../mpzfs-1-switching-personalities>Part 1: Switching Personalities</a></li><li><a href=../mpzfs-2-export-import-business>Part 2: The Export/Import Business</a></li><li><a href=../mpzfs-3-no-special-snowflakes>Part 3: No Special Snowflakes</a></li></ul><h2 id=background>Background</h2><p>I&rsquo;ve built up a fair amount of data that I want to preserve on this computer. And I want to access it from either of the operating systems on it, without copying it back and forth and letting the two halves get out of sync. So the files they share in common would have to use the same on-disk formats. I&rsquo;ll just choose a file system that both operating systems can read and write, right? <a href=https://en.wikipedia.org/wiki/File_Allocation_Table#FAT32>FAT32</a> and <a href=https://en.wikipedia.org/wiki/Bob%27s_your_uncle>Bob&rsquo;s your uncle</a>.</p><p>There&rsquo;s a problem with that idea. Consider that the tin/ matter of syncing a couple of <em>terabytes</em> of data to an external SSD formatted with that file system took <em>days.</em> When I reformatted it to something more reasonable (i.e. a UNIX-like file system) it only took <em>hours.</em> And that&rsquo;s to say absolutely nothing about data integrity or any of that other stuff. (I know I don&rsquo;t like it when my data randomly changes on me because a mosquito on the other side of the planet sneezed. Do you?)</p><p>Last I checked, the various BSDs and <a href=https://www.kernel.org/linux.html>Linux</a> didn&rsquo;t really support each other&rsquo;s native file systems very well. I hear there are facilities like <a href=https://en.wikipedia.org/wiki/Filesystem_in_Userspace>FUSE</a> which can bridge the gap, but I&rsquo;m really looking for something that feels native in both worlds: implemented in the kernel or in loadable kernel modules from a reputable source.</p><p><a href=https://en.wikipedia.org/wiki/ZFS>ZFS</a> is an awesome way to manage computer storage. It has too many features for me to describe here, but the killer features for me is how little space it wastes. You don&rsquo;t have to guess how much space a particular file system will take in several years&rsquo; time. You won&rsquo;t run out of space until your entire pool of storage runs out of space.</p><p>ZFS has some <a href=https://docs.freebsd.org/en/books/handbook/zfs/#zfs-term>terminology</a> which I will be using here:</p><dl><dt>storage pool</dt><dd>A collection of one or more devices (entire disks or partitions) providing storage.</dd><dt>dataset</dt><dd>A file system, snapshot, or volume that consumes storage from one storage pool.</dd><dt>property</dt><dd>Metadata about a storage pool or dataset, such as where it appears within the directory tree structure presented to users.</dd></dl><p><a href=https://www.freebsd.org/>FreeBSD</a> has been <a href=https://docs.freebsd.org/en/books/handbook/zfs/>happily using ZFS</a> for quite a while now, and they have adopted the <a href=https://openzfs.org/>OpenZFS</a> project&rsquo;s implementation of ZFS. OpenZFS also works well on <a href=https://ubuntu.com/>Ubuntu</a> and other distributions of Linux.</p><p>Well, isn&rsquo;t that interesting! My hobby PC is primarily running Ubuntu, but I&rsquo;d rather be running FreeBSD for as much of it as I can. (There may be some applications that are just too gnarly to work equally well on both; I&rsquo;m willing to put up with that.) Maybe I don&rsquo;t have to copy files back and forth after all. And I do have the ability to create virtual machines pretty easily. Perhaps an experiment is in order!</p><h2 id=the-standard-test-bed>The standard test bed</h2><p>Since I don&rsquo;t want to trash my hobby PC, I&rsquo;ll create a virtual machine instead and trash it instead. In terms of its virtual hardware, I&rsquo;ll give it:</p><ul><li>8 GB of memory</li><li>2 virtual CPUs</li><li>an <a href=https://en.wikipedia.org/wiki/Ethernet>ethernet</a> network interface</li><li>a 40 GB <a href=https://en.wikipedia.org/wiki/SCSI>SCSI</a> hard drive for operating systems</li><li>a 20 GB SCSI hard drive for the shared data</li><li>no sound card</li><li>no camera</li><li><a href=https://en.wikipedia.org/wiki/UEFI>UEFI</a> firmware</li></ul><p>This experiment should work with any <a href=https://en.wikipedia.org/wiki/Hypervisor>hypervisor</a> that supports booting guests from UEFI. I&rsquo;m assuming I can do this because the physical machine I&rsquo;m trying to imitate boots from UEFI. The physical machine does not use SCSI hardware, but the hypervisor available to me offered it as a suggestion for the machine I was trying to build, so I took it. The device names may change a bit for <a href=https://en.wikipedia.org/wiki/SATA>SATA</a> or <a href=https://en.wikipedia.org/wiki/NVMe>NVMe</a> drives, but the concepts should still apply.</p><h2 id=what-would-freebsd-do>What would FreeBSD do?</h2><p>I&rsquo;ll start by installing FreeBSD 13.1-RELEASE in the standard way from the usual downloadable ISO image, telling it to use the entirety of the first disk as a ZFS storage pool. Then I&rsquo;ll see what the resulting <a href=https://en.wikipedia.org/wiki/GUID_Partition_Table>GPT</a> looks like.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>FreeBSD calls the first SCSI disk <code>da0</code>, and the various GPT partitions within it <code>da0p1</code>, <code>da0p2</code>, etc. (For SATA the device names would be <code>ada0</code> for the disk itself and <code>ada0p1</code> for the first GPT partition on it.)</p><pre><code class=language-text># gpart show da0
=&gt;       40  83886000  da0  GPT (40G)
         40    532480    1  efi  (260M)
     532520      1024    2  freebsd-boot  (512K)
     533544       984       - free -  (492K)
     534528    494304    3  freebsd-swap  (2.0G)
    4728832  71955200    4  freebsd-zfs  (38G)
   83884032      2008       - free -  (1.0M)

# cat /etc/fstab
# Device Mountpoint FStype Options Dump Pass#
/dev/da0p1 /boot/efi msdosfs rw 2 2
/dev/da0p3 none swap sw 0 0
</code></pre><p>ZFS does not need the traditional <code>/etc/fstab</code> method to get everything mounted. Every dataset in a storage pool that sets a property named <code>mountpoint</code> can declare its preferred mount point. ZFS reads all these properties to get things mounted. A storage pool has its usual mount point set when it is initially created, but one can use the property <code>altroot</code> to <em>temporarily</em> change the mount point for the root dataset in the pool. This can be very useful when attempting storage shenanigans (i.e. this experiment), or when you want to tell your operating system&rsquo;s installer that yes, you really want all of your file systems to be ZFS datasets!</p><h2 id=what-would-ubuntu-do>What would Ubuntu do?</h2><p>Let&rsquo;s repeat the exercise with Ubuntu 22.04 LTS &ldquo;Jammy Jellyfish,&rdquo; using their server install media. Linux calls the first SCSI disk <code>sda</code>, with the partitions within it being <code>sda1</code>, <code>sda2</code>, etc. (The device names appear to be the same for SATA disks.)</p><pre><code class=language-text># fdisk -l /dev/sda
# ...
Disklabel type: gpt
# ...
Device       Start      End  Sectors  Size Type
/dev/sda1     2048  2203647  2201600    1G EFI System
/dev/sda2  2203648  6397951  4194304    2G Linux filesystem
/dev/sda3  6397952 83884031 77486080 36.9G Linux filesystem
</code></pre><h2 id=adding-zfs>Adding ZFS</h2><p>I assumed that creating a new storage pool under Ubuntu would be more likely to produce compatible results. So away we go! Running with superuser permissions, either via <code>sudo</code> or from a proper root shell, I&rsquo;ll dedicate that entire second SCSI disk (<code>sdb</code> in Linux-speak, <code>da1</code> in FreeBSD-speak) to it.</p><pre><code class=language-sh>apt install zfsutils-linux
zpool create zdata /dev/sdb
zfs create -o mountpoint=/zhome zdata/home
</code></pre><p>Now how does the partition table on <code>sdb</code> look?</p><pre><code class=language-text># fdisk -l /dev/sdb
# ...
Disklabel type: gpt
# ...
Device        Start      End  Sectors Size Type
/dev/sdb1      2048 41924607 41922560  20G Solaris /usr &amp; Apple ZFS
/dev/sdb9  41924608 41940991    16384   8M Solaris reserved 1
</code></pre><p>It built a GPT for us. How considerate!</p><p>One of the neat things about storage pools is that you can mount them on any system than understands them and you should be able to pick up where you left off. This is called <em>importing</em> a storage pool. Which implies that it must be <em>exported,</em> even if you don&rsquo;t move physical disks around. And such a concept does exist; it is the act of logically detaching the storage pool from the system and marking it as not currently in use by that system.</p><p>Before I shut down, I&rsquo;ll export <code>zdata</code> to see if I can import it.</p><pre><code class=language-nil>zpool export zdata
</code></pre><p>Note that if I had any mounted file systems (datasets) from <code>zdata</code>, <code>zpool export</code> would unmount them immediately before export. I&rsquo;ll remember that as something I&rsquo;d like to perform automatically upon every shutdown.</p><h2 id=but-can-we-really-share-it>But can we really share it?</h2><p>I booted from the FreeBSD install media and intentionally chose the most difficult partitioning option so as not to disturb the Ubuntu install. It was <a href=https://github.com/tnalpgge/multiple-personality-zfs/tree/main/attempt-0-ubuntu/freebsd/install/10_filesystems.sh>a lot of typing</a>, based on <a href="https://www.freebsd.org/cgi/man.cgi?query=bsdinstall&amp;apropos=0&amp;sektion=0&amp;manpath=FreeBSD+13.1-RELEASE+and+Ports&amp;arch=default&amp;format=html#end">research</a> I had done a while ago into automated customized FreeBSD installs.</p><p>I had arrived at this GPT:</p><pre><code class=language-text># gpart show da0
=&gt;      34  83886013  da0  GPT  (40G)
        34      1024    4 freebsd-boot  (512K)
      1058       990      - free -  (495K)
      2048   2201600    1 efi  (1.0G)
   2203648   4194304    2 linux-data  (2.0G)
   6397952  37748736    3 linux-data  (18G)
  44146688   4194304    5 freebsd-swap  (2.0G)
  48340992  35543040    6 freebsd-zfs  (17G)
  83884032      2015      - free -  (1.0M)
</code></pre><p>I had assumed at this point that I was doing quite well. It wasn&rsquo;t a terrible assumption, but it wasn&rsquo;t that great either. Why? Because I hadn&rsquo;t yet wrestled with the elephant in the room: easily booting one computer into either operating system without relying upon install media.</p><p>I&rsquo;ll start that wrestling match in the <a href=../mpzfs-1-switching-personalities>next post in the series</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>&ldquo;GPT partition table&rdquo; is a redundant phrase.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div id=links><a href=https://tnalpgge.github.io/technically-nightshade/posts/sdrawkcab-gnitirw/>&#171;&nbsp;sdrawkcaB gnitirW</a>
<a href=https://tnalpgge.github.io/technically-nightshade/posts/mpzfs-1-switching-personalities/>Multiple Personality ZFS Part 1: Switching Personalities&nbsp;&#187;</a></div></section></body></html>