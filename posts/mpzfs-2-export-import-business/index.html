<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content><link href="https://fonts.googleapis.com/css?family=Newsreader:400|Fira+Code:400|Inter:400|EB+Garamond:400&display=swap" rel=stylesheet media=print type=text/css onload='this.media="all"'><title>Multiple Personality ZFS Part 2: The Export/Import Business</title><link rel=canonical href=https://tnalpgge.github.io/technically-nightshade/posts/mpzfs-2-export-import-business/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:Newsreader,free serif,times new roman,Times,serif;font-size:x-large;line-height:108%;color:#000;max-width:72%;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre{font:"Fira Code",Courier,courier new,Menlo,Monaco,andale mono,lucida console,monospace;background-color:#eee}code{font-size:medium;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:medium;line-height:126%}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:Inter,Helvetica,liberation sans,sans-serif}.mono,pre,code,tt,p code,li code{font-family:fira code,Courier,courier new,Menlo,Monaco,andale mono,lucida console,monospace}.heading,h1,.serif{font-family:Newsreader,free serif,times new roman,Times,serif}h2,h3,h4,h5,h6,.sans-serif{font-family:Inter,Helvetica,liberation sans,sans-serif;font-weight:700}strong{font-weight:600}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:eb garamond,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:eb garamond,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-size:35px}h2{font-size:28px}h3{font-size:22px;margin-top:18px}h1 a,h3 a{text-decoration:none}h2 a{font-family:Newsreader,free serif,times new roman,Times,serif}h1,h2{margin-top:28px}#sub-header,.date{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content .date{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:ttable-cell;font-size:15px;padding:0 20px;font-family:Inter,Helvetica,liberation sans,sans-serif}#links{display:flex;justify-content:space-between;margin:50px 0 0}#links :nth-child(1){margin-right:.5em}#links :nth-child(2){margin-left:.5em}#not-found{text-align:center}#not-found a{font-family:eb garamond,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}dt{font-weight:700;font-style:italic}dd{padding-left:3%}a{color:#080}a:visited{color:#808}a:hover{color:#fff;background-color:#080}.footnote-ref{vertical-align:super;font-size:smaller}table{width:90%}th{font-family:Inter,Helvetica,liberation sans,sans-serif;font-weight:700;border-bottom:1px solid #888}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}@media(prefers-color-scheme:dark){*,#nav h1 a{color:#fdfdfd}body{background:#121212}pre,code{background-color:#262626}#sub-header,.date{color:#bababa}hr{background:#ebebeb}}</style></head><body><section id=nav><h1><a href=/>tnalpgge.github.io</a></h1><ul><li><a href=/technically-nightshade/>Technically Nightshade</a></li></ul></section><section id=content><h1>Multiple Personality ZFS Part 2: The Export/Import Business</h1><div id=sub-header>27 December 2022 · 5 minute read</div><div class=entry-content><p>I have spread story of this journey across a series of posts:</p><ul><li><a href=../mpzfs-0-questionable-idea>Part 0: A Questionable Idea</a></li><li><a href=../mpzfs-1-switching-personalities>Part 1: Switching Personalities</a></li><li><strong><a href=../mpzfs-2-export-import-business>Part 2: The Export/Import Business</a></strong> ⇐ you are here</li><li><a href=../mpzfs-3-no-special-snowflakes>Part 3: No Special Snowflakes</a></li></ul><h2 id=now-back-to-the-important-stuff>Now back to the important stuff</h2><p>So I need to export my chosen <a href=https://en.wikipedia.org/wiki/ZFS>ZFS</a> storage pool every time <a href=https://ubuntu.com/>Ubuntu</a> shuts down. As much as I prefer the <a href=https://www.freebsd.org/>FreeBSD</a> system of initialization scripts, and regard <a href=https://systemd.io/>systemd</a> with a degree of suspicion, it is generally a good idea to work within the framework that the operating system provides until it proves inadequate. And for this purpose, it was indeed adequate. A few more web searches yielded these useful links:</p><ul><li><a href=https://askubuntu.com/questions/1212053/zfs-pools-not-automatically-exported-on-reboot>ZFS Pools not automatically exported on reboot</a></li><li><a href=https://www.psdn.io/posts/systemd-shutdown-unit/>systemd Shutdown Units</a></li></ul><p>Which I boiled down to this <strong>systemd</strong> service, stored in <code>/etc/systemd/system/zpool-export.service</code>:</p><pre><code class=language-cfg>[Unit]
Description=ZFS Pool Export
Before=zfs.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/bin/true
ExecStop=/usr/sbin/zpool export -a -f

[Install]
WantedBy=zfs.target
</code></pre><p>It&rsquo;s a blunt instrument, thanks to the <code>-a</code> and <code>-f</code> flags. I&rsquo;ll probably have to refine it later to be more precise. And that&rsquo;s assuming that it&rsquo;s what I want. (I have a hunch I&rsquo;m missing a detail or two.) I won&rsquo;t know until I try. Time to install it and get it working.</p><pre><code class=language-sh>systemctl daemon-reload
systemctl enable zpool-export.service
systemctl start zpool-export.service
</code></pre><p>Now I can reboot back into Ubuntu as many times as I want in a row and the datasets in the <code>zdata</code> storage pool mount automatically. But that&rsquo;s not really an accomplishment, is it? That&rsquo;s what the operating system would do anyway for me. I&rsquo;m not handling anything differently yet.</p><p>I have to address FreeBSD&rsquo;s needs. I want to be able to boot back and forth between the two freely, and see the same data on the shared pool.</p><p>Examining the various <strong>systemd</strong> units that came with the <code>zfsutils-linux</code> package,<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> I saw that they were taking a two-step approach:</p><ol><li>import the storage pools <em>without</em> mounting the datasets as file systems</li><li>mount all the ZFS datasets as file systems</li></ol><p>I adopted the same strategy, but shoehorned it into scripts that would work well with FreeBSD&rsquo;s initialization system &ndash; specifically with the library <a href="https://www.freebsd.org/cgi/man.cgi?query=rc.subr&apropos=0&sektion=0&manpath=FreeBSD+13.1-RELEASE+and+Ports&arch=default&format=html"><code>/etc/rc.subr</code></a> that can make writing these scripts easier.</p><p>First, I wrote a script to import the storage pools from certain devices but not mount them when its service &ldquo;starts,&rdquo; and export those same storage pools when its service &ldquo;stops.&rdquo; I installed it as <a href=https://github.com/tnalpgge/multiple-personality-zfs/tree/main/attempt-0-ubuntu/freebsd/post-install/usr/local/etc/rc.d/zpool-shared><code>/usr/local/etc/rc.d/zpool-shared</code></a>.</p><p>Then, I wrote a script that &ldquo;starts&rdquo; its service by mounting the ZFS datasets from those storage pools as file systems. And do the opposite when the service &ldquo;stops.&rdquo; I installed it as <a href=https://github.com/tnalpgge/multiple-personality-zfs/tree/main/attempt-0-ubuntu/freebsd/post-install/usr/local/etc/rc.d/zfs-shared><code>/usr/local/etc/rc.d/zfs-shared</code></a>.</p><p>Add in a few key comments such as <code>PROVIDE:</code> and <code>REQUIRE:</code> so that FreeBSD can properly order the scripts and that should be it! Let&rsquo;s set the key variables that trigger the desired behaviors from FreeBSD&rsquo;s initialization system.</p><pre><code class=language-sh>sysrc zpool_shared_enable=YES zpool_shared_devices=/dev/da1p1 zpool_shared_pools=zdata
sysrc zfs_shared_enable=YES zfs_shared_datasets=zdata
</code></pre><p><strong><a href="https://www.freebsd.org/cgi/man.cgi?query=sysrc&apropos=0&sektion=0&manpath=FreeBSD+13.1-RELEASE+and+Ports&arch=default&format=html">sysrc</a></strong> sets values in <a href="https://www.freebsd.org/cgi/man.cgi?query=rc.conf&apropos=0&sektion=0&manpath=FreeBSD+13.1-RELEASE+and+Ports&arch=default&format=html"><code>/etc/rc.conf</code></a> that are useful for configuring the system and its services.</p><p><code>zpool_shared_enable</code> and <code>zfs_shared_enable</code> should be self-explanatory by their names.</p><p><code>zpool_shared_devices</code> specifies what devices to search on for storage pools. <code>zpool_shared_pools</code> gives the names of the pools I expect to find. <code>zfs_shared_datasets</code> lists the common prefixes of dataset names (usually the names of the storage pools that contain them) that are considered interesting for this purpose. Note this does not include the main FreeBSD storage pool which the installer traditionally names <code>zroot</code>.</p><p>I booted back and forth between Ubuntu and FreeBSD, using the appropriate GRUB menu entries, and saw that the <code>zdata</code> pool and its datasets were not always mounted. This would take some debugging, mostly on the Ubuntu side. It looks like my attempt at a <code>zpool-export.service</code> didn&rsquo;t work out so well. Time to remove it.</p><pre><code class=language-nil>systemctl disable zpool-export.service
rm /etc/systemd/system/zpool-export.service
</code></pre><p>To imitate the approach that was working on the FreeBSD side, I created two <strong>systemd</strong> services, one for the storage pools and the other for the data sets. I offloaded all the logic into scripts stored in <a href=https://github.com/tnalpgge/multiple-personality-zfs/tree/main/attempt-0-ubuntu/ubuntu/post-install/usr/local/sbin/zpool-shared><code>/usr/local/sbin/zpool-shared</code></a> and <a href=https://github.com/tnalpgge/multiple-personality-zfs/tree/main/attempt-0-ubuntu/ubuntu/post-install/usr/local/sbin/zfs-shared><code>/usr/local/sbin/zfs-shared</code></a> respectively. Instead of reading values (indirectly) from <code>/etc/rc.conf</code> they would look in <a href=https://github.com/tnalpgge/multiple-personality-zfs/tree/main/attempt-0-ubuntu/post-install/etc/default/zpool-shared><code>/etc/default/zpool-shared</code></a> and <a href=https://github.com/tnalpgge/multiple-personality-zfs/tree/main/attempt-0-ubuntu/post-install/etc/default/zfs-shared><code>/etc/default/zfs-shared</code></a> respectively for key variables. Aside from the specific variable names and the details of dealing with each operating system&rsquo;s initialization paradigms, the main logic of the scripts for both operating systems was identical.</p><p>There were two main sources of trouble:</p><ul><li><strong>systemd</strong> was trying to mount the ZFS datasets before the storage pool completed its import. Hooray for <a href=https://en.wikipedia.org/wiki/Race_condition>race conditions</a>!</li><li>The scripts were not gracefully handling the cases where the storage pools were already imported or the datasets were already mounted.</li></ul><p>I addressed the timing problem by reading the following <strong>systemd</strong> manual pages:</p><ul><li><a href=https://www.freedesktop.org/software/systemd/man/systemd.exec.html#><code>systemd.exec</code></a></li><li><a href=https://www.freedesktop.org/software/systemd/man/systemd.service.html#><code>systemd.service</code></a></li><li><a href=https://www.freedesktop.org/software/systemd/man/systemd.target.html#><code>systemd.target</code></a></li><li><a href=https://www.freedesktop.org/software/systemd/man/systemd.unit.html#><code>systemd.unit</code></a></li></ul><p>In particular, proper use of <code>Requires</code>, <code>After</code>, and <code>WantedBy</code> got me the ordering I was looking for, which is summarized here:</p><table><thead><tr><th>Unit file</th><th>Section</th><th>Ordering constraint</th></tr></thead><tbody><tr><td><code>zpool-shared.service</code></td><td><code>Unit</code></td><td><code>Requires=zfs.target</code></td></tr><tr><td><code>zpool-shared.service</code></td><td><code>Unit</code></td><td><code>After=zfs.target</code></td></tr><tr><td><code>zpool-shared.service</code></td><td><code>Install</code></td><td><code>Requires=zpool-shared.service</code></td></tr><tr><td><code>zfs-shared.service</code></td><td><code>Unit</code></td><td><code>Requires=zpool-shared.target</code></td></tr><tr><td><code>zfs-shared.service</code></td><td><code>Unit</code></td><td><code>After=zpool-shared.target</code></td></tr><tr><td><code>zfs-shared.service</code></td><td><code>Install</code></td><td><code>WantedBy=multi-user.target</code></td></tr></tbody></table><p>But does it reproduce? All this work is worth approximately <em>bupkis</em> if nobody can reproduce it.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> I&rsquo;ll try to answer that in the <a href=../mpzfs-3-no-special-snowflakes>conclusion of the series</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>You can discover the particular set of files via either of the following:</p><pre><code class=language-sh>find /lib/systemd/system -type f -name 'zfs*'
</code></pre><pre><code class=language-sh>dpkg-query -L zfsutils-linux | grep ^/lib/systemd/system/
</code></pre>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li><li id=fn:2><p>This colorful Yiddish word may have originally meant beans but evolved to describe the excrement of certain ungulates. In modern usage, one of its synonyms is <a href="https://www.urbandictionary.com/define.php?term=the%20square%20root%20of%20bugger%20all">&ldquo;the square root of bugger all.&rdquo;</a> Ungulate excrement is generally regarded as not immediately and directly useful for computing, though there may be extremely indirect applications that remain to be researched.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div id=links><a href=https://tnalpgge.github.io/technically-nightshade/posts/mpzfs-1-switching-personalities/>&#171;&nbsp;Multiple Personality ZFS Part 1: Switching Personalities</a>
<a href=https://tnalpgge.github.io/technically-nightshade/posts/mpzfs-3-no-special-snowflakes/>Multiple Personality ZFS Part 3: No Special Snowflakes&nbsp;&#187;</a></div></section></body></html>