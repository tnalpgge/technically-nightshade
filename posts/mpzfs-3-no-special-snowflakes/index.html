<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content><link href="https://fonts.googleapis.com/css?family=Newsreader:400|Fira+Code:400|Inter:400|EB+Garamond:400&display=swap" rel=stylesheet media=print type=text/css onload='this.media="all"'><title>Multiple Personality ZFS Part 3: No Special Snowflakes
</title><link rel=canonical href=https://tnalpgge.github.io/technically-nightshade/posts/mpzfs-3-no-special-snowflakes/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:Newsreader,free serif,times new roman,Times,serif;font-size:x-large;line-height:108%;color:#000;max-width:72%;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre{font:"Fira Code",Courier,courier new,Menlo,Monaco,andale mono,lucida console,monospace;background-color:#eee}code{font-size:medium;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:medium;line-height:126%}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:Inter,Helvetica,liberation sans,sans-serif}.mono,pre,code,tt,p code,li code{font-family:fira code,Courier,courier new,Menlo,Monaco,andale mono,lucida console,monospace}.heading,h1,.serif{font-family:Newsreader,free serif,times new roman,Times,serif}h2,h3,h4,h5,h6,.sans-serif{font-family:Inter,Helvetica,liberation sans,sans-serif;font-weight:700}strong{font-weight:600}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:eb garamond,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:eb garamond,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-size:35px}h2{font-size:28px}h3{font-size:22px;margin-top:18px}h1 a,h3 a{text-decoration:none}h2 a{font-family:Newsreader,free serif,times new roman,Times,serif}h1,h2{margin-top:28px}#sub-header,.date{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content .date{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:ttable-cell;font-size:15px;padding:0 20px;font-family:Inter,Helvetica,liberation sans,sans-serif}#links{display:flex;justify-content:space-between;margin:50px 0 0}#links :nth-child(1){margin-right:.5em}#links :nth-child(2){margin-left:.5em}#not-found{text-align:center}#not-found a{font-family:eb garamond,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}dt{font-weight:700;font-style:italic}dd{padding-left:3%}a{color:#080}a:visited{color:#808}a:hover{color:#fff;background-color:#080}.footnote-ref{vertical-align:super;font-size:smaller}table{width:90%}th{font-family:Inter,Helvetica,liberation sans,sans-serif;font-weight:700;border-bottom:1px solid #888}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}@media(prefers-color-scheme:dark){*,#nav h1 a{color:#fdfdfd}body{background:#121212}pre,code{background-color:#262626}#sub-header,.date{color:#bababa}hr{background:#ebebeb}}</style></head><body><section id=nav><h1><a href=/>tnalpgge.github.io</a></h1><ul><li><a href=/technically-nightshade/>Technically Nightshade</a></li></ul></section><section id=content><h1>Multiple Personality ZFS Part 3: No Special Snowflakes</h1><div id=sub-header>27 December 2022 · 7 minute read</div><div class=entry-content><p>I have spread story of this journey across a series of posts:</p><ul><li><a href=../mpzfs-0-questionable-idea>Part 0: A Questionable Idea</a></li><li><a href=../mpzfs-1-switching-personalities>Part 1: Switching Personalities</a></li><li><a href=../mpzfs-2-export-import-business>Part 2: The Export/Import Business</a></li><li><strong><a href=../mpzfs-3-no-special-snowflakes>Part 3: No Special Snowflakes</a></strong> ⇐ you are here</li></ul><h2 id=but-does-it-reproduce>But does it reproduce?</h2><p>My co-workers know me as a person who likes command lines, and whose definition of a <a href=https://www.perl.com/article/perl-one-liners-part-1/>&ldquo;one-liner&rdquo;</a> may be a bit&mldr;expansive at times. The challenge for me, therefore, is to replicate the results in a slightly different environment, with fewer frills, with fewer graphical installs, and more typing. I chose to replace <a href=https://ubuntu.com/>Ubuntu</a> 22.04 LTS &ldquo;Jammy Jellyfish&rdquo; with <a href=https://www.debian.org/>Debian</a> 11 &ldquo;Bullseye,&rdquo; selecting only the most basic options, to see if it would work as easily. (I&rsquo;m keeping <a href=https://www.freebsd.org/>FreeBSD</a> in <em>every</em> iteration of this experiment, thank you very much!)</p><p>In particular, the Debian install media offers no distinction between a server and a desktop. You get the features you ask for and you don&rsquo;t get the features you don&rsquo;t.</p><h2 id=a-new-machine-part-1-debian>A new machine part 1: Debian</h2><p>I created a new virtual machine that had the same shape and size, but with fresh disks of its own:</p><ul><li>8 GB of memory</li><li>2 virtual CPUs</li><li>an <a href=https://en.wikipedia.org/wiki/Ethernet>ethernet</a> network interface</li><li>a 40 GB <a href=https://en.wikipedia.org/wiki/SCSI>SCSI</a> hard drive for operating systems</li><li>a 20 GB SCSI hard drive for the shared data</li><li>no sound card</li><li>no camera</li><li><a href=https://en.wikipedia.org/wiki/UEFI>UEFI</a> firmware</li></ul><p>I ran through the Debian installer in a fairly straightforward form, and manually chose a set of disk partitions that consumed approximately half the disk. I planned them out to look like this:</p><table><thead><tr><th>Index</th><th>Size</th><th>Filesystem</th><th>Mount point</th><th>Name</th><th>Purpose</th></tr></thead><tbody><tr><td>1</td><td>1 GB</td><td>EFI</td><td>(automatic)</td><td>efi</td><td>EFI system partition</td></tr><tr><td>2</td><td>2 GB</td><td>ext4</td><td><code>/boot</code></td><td>linux-boot</td><td>Linux boot</td></tr><tr><td>3</td><td>18 GB</td><td>linux-lvm</td><td>see below</td><td>linux-lvm</td><td>Linux LVM</td></tr><tr><td>4</td><td>2 GB</td><td>swap</td><td>(none)</td><td>swap</td><td>Swap</td></tr></tbody></table><p>Within the <a href=https://sourceware.org/lvm2/>LVM</a> partition <code>/dev/sda3</code> I created:</p><ul><li>One single volume group <code>vg0</code>, consuming as much as possible;</li><li>One single logical volume <code>lv0</code>, consuming as much as possible, mounted at <code>/</code>.</li></ul><p>The rest of the disk would be consumed by FreeBSD.</p><p>I had <del>brilliantly</del><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> declined to install the common system utilities. When I finally rebooted into this fresh system, I had to use the <strong>su</strong> utility and a root password &ndash; much like UNIX system administrators of yore &ndash; to reach a tolerable setup where I could use <strong>sudo</strong> and a screen-oriented text editor.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> But after that brief ordeal, it was time to install the <a href=https://en.wikipedia.org/wiki/ZFS>ZFS</a> packages via the <a href=https://openzfs.org/>OpenZFS</a> project&rsquo;s <a href=https://openzfs.github.io/openzfs-docs/Getting%20Started/Debian/index.html>getting started guide for Debian</a>. Examining the system with available text-oriented tools, I saw the following:</p><pre><code class=language-text>$ lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda           8:0    0   40G  0 disk
|-sda1        8:1    0  953M  0 part /boot/efi
|-sda2        8:2    0  1.9G  0 part /boot
|-sda3        8:3    0 16.8G  0 part
| `-vg0-lv0 254:0    0 16.8G  0 lvm  /
`-sda4        8:4    0  1.9G  0 part [SWAP]
sdb           8:16   0   20G  0 disk
|-sdb1        8:17   0   20G  0 part
`-sdb9        8:25   0    8M  0 part
sr0           11:0   1 1024M  0 rom
</code></pre><p>This looks like a reasonable arrangement of block storage devices. What can it tell us about the partition table?</p><pre><code class=language-text>$ sudo partx -s /dev/sda
NR    START      END  SECTORS  SIZE NAME       UUID
 1     2048  1953791  1951744  953M efi        ...
 2  1953792  5859327  3905536  1.9G linux-boot ...
 3  5859328 41015295 35155968 16.8G linux-lvm  ...
 4 41015296 44920831  3905536  1.9G swap       ...
</code></pre><p>That also looks good.</p><p>I created the <code>zdata</code> storage pool on <code>sdb1</code> and the <code>zdata/home</code> dataset within it:</p><pre><code class=language-sh>zpool create zdata /dev/sdb
</code></pre><p>Examining the partition table on <code>sdb</code>:</p><pre><code class=language-text>$ sudo partx -s /dev/sdb
NR    START      END  SECTORS SIZE NAME                 UUID
 1     2048 41924607 41922560 20G  zfs-be42e62def1bd6ad ...
 9 41924608 41940991    16384  8M                       ...
</code></pre><p>It was consistent with what we saw before on the Ubuntu machine.</p><pre><code class=language-text>$ zpool list
NAME    SIZE  ALLOC   FREE CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zdata  19.5G   184K  19.5G       -         -     0%     0%  1.00x    ONLINE  -
</code></pre><p>So I created a dataset and proved it was what I wanted:</p><pre><code class=language-sh>zfs create -o mountpoint=/zhome zdata/home
</code></pre><pre><code class=language-text>$ zfs list
NAME         USED  AVAIL     REFER  MOUNTPOINT
zdata        184K  18.9G       24K  /zdata
zdata/home  24.5K  18.9G     24.5K  /zhome
</code></pre><p>The data sets were mounted as well.</p><pre><code class=language-text>$ df
Filesystem           Size  Used Avail Use% Mounted on
udev                 3.9G     0  3.9G   0% /dev
tmpfs                796M  660K  796M   1% /run
/dev/mapper/vg0-lv0   17G  1.6G   16G  10% /
tmpfs                3.9G     0  3.9G   0% /dev/shm
tmpfs                3.0M     0  5.0M   0% /run/lock
/dev/sda2            1.8G   50M  1.7G   3% /boot
/dev/sda1            952M  5.8M  946M   1% /boot/efi
zdata                 19G  128K   19G   1% /zdata
zdata/home            19G  128K   19G   1% /zhome
</code></pre><p>I got lucky with one of the choices that Debian made:</p><pre><code class=language-text>$ mount | grep /boot/efi
/dev/sda1 on /boot/efi type vfat (rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro)
</code></pre><p>What Debian calls <code>vfat</code> FreeBSD calls <code>msdosfs</code>, which can be mounted and written natively by the operating system, without adding any external packages. So hopefully we won&rsquo;t have to engage in a manual step to get the FreeBSD boot loader executable in place.</p><p>I proceeded to copy files from the Ubuntu+FreeBSD machine over the network so I could install the scripts and <strong>systemd</strong> units without typing them all over again.</p><p>The <a href=https://www.gnu.org/software/grub/>GRUB</a> setup was much friendlier on Debian, allowing a five-second view of the menu before proceeding. I changed it to 30 seconds to match what I had previously.</p><pre><code class=language-sh>sed -i -e '/GRUB_TIMEOUT=/s/=.*/=30/' /etc/default/grub
update-grub
</code></pre><p>Time to attend to the other half of the machine.</p><h2 id=a-new-machine-part-2-freebsd>A new machine part 2: FreeBSD</h2><p>I only needed to add one partition to the <a href=https://en.wikipedia.org/wiki/GUID_Partition_Table>GPT</a> via the FreeBSD installer:</p><pre><code class=language-sh>gpart add -t freebsd-zfs -l freebsd-zfs da0
</code></pre><p>And that would be dedicated to the operating system. I created a storage pool within this partition and the approximately-standard group of datasets. (It&rsquo;s a long script but not presented here.) This time we could add <code>/boot/efi</code> to <code>/etc/fstab</code> in addition to the designated swap area before we let the installer have its way.</p><pre><code class=language-sh>cat &gt;&gt;/tmp/bsdinstall_etc/fstab &lt;&lt;EOF
    /dev/da0p1			/boot/efi	msdosfs	rw,sync,noatime,-m=600,-M=700	2	2
    /dev/da0p4			none	swap	sw	0	0
EOF
</code></pre><p>When adding users to the system, I chose my UID to match what Debian had gave me (1000).</p><p>After the install, the system rebooted immediately into FreeBSD. Which was not bad but not what I expected.</p><h2 id=a-new-machine-part-3-the-reluctant-grub>A new machine part 3: The Reluctant GRUB</h2><p>Messing with the partition table didn&rsquo;t help. It was booting off the correct partition already, the EFI file system. The FreeBSD installer had noticed that <code>/boot/efi</code> was writeable, so it dropped its own EFI boot loader into the key position of <code>EFI/boot/bootx64.efi</code>. How did I discover this? Mostly by comparing file lengths of the files within that partition:</p><pre><code class=language-sh>find /boot/efi -type f -iname '*.efi' -ls | sort -k7 -n
</code></pre><p>To remind myself how to fix the situation, I referred to the previous experiment with Ubuntu and examined its <code>/boot/efi</code> file system, before settling on the following procedure:</p><pre><code class=language-sh>cp /boot/efi/EFI/debian/shimx64.efi /boot/efi/EFI/boot/bootx64.efi
cp /boot/efi/EFI/debian/fbx64.efi /boot/efi/EFI/boot/
cp /boot/efi/EFI/debian/mmx64.efi /boot/efi/EFI/boot/
</code></pre><p>And after a reboot I was indeed presented with GRUB. So I booted back into FreeBSD and copied the FreeBSD-related files from the other machine to install them.</p><p>After a few reboots back and forth I found that I had indeed reproduced the setup; the <code>zdata</code> pool imported properly every time, and the datasets within it mounted at the desired locations.</p><h2 id=putting-the-lessons-to-use>Putting the lessons to use</h2><p>I don&rsquo;t think I have anything on the hobby PC that strictly relies upon Ubuntu being Ubuntu. It does make certain applications easier to obtain, but all the applications I care about for the hobby are generally Linux-friendly, so changing out Ubuntu for Debian seems plausible. I might even get some more fine-grained control over how the resulting machine looks.</p><p>I have a 500 GB USB SSD lying around, not seeing a lot of use. Perhaps I could create a ZFS storage pool on it, back up the existing hobby PC to it, and use that as a starting point for a rebuild.</p><h2 id=final-products>Final products</h2><p>I have stored the various artifacts that came out of this experiment in a <a href=https://github.com/tnalpgge/multiple-personality-zfs>repository</a>.</p><p>Reward yourself with a festive beverage for reading this far!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>You may translate the redacted word as &ldquo;stupidly&rdquo; if you wish.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>I can, in fact, <strong><a href=https://www.gnu.org/fun/jokes/ed-msg.html>ed</a></strong> my way out of a wet paper bag.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div id=links><a href=https://tnalpgge.github.io/technically-nightshade/posts/mpzfs-2-export-import-business/>&#171;&nbsp;Multiple Personality ZFS Part 2: The Export/Import Business</a></div></section></body></html>